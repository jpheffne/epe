---
title: "EPE Manuscript Analyses"
author: "Joey Heffner"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
---

# EPE Manuscript Analysis

The order of this Markdown will follow the order of results in the manuscript. 

## Setup

To run this analysis script you'll have to have the following packages installed (make sure `tidyverse` is updated): 

|Packages1  |Packages2    |Packages3 |Packages4    |
|:---------:|:-----------:|:--------:|:-----------:|
|`here`     |`tidyverse`  |`knitr`   |`kableExtra` |
|`lsr`      |`lme4`       |`lmerTest`|`broom.mixed`|
|`AICmodavg`|`cowplot`    |`ggrepel` |`gridExtra`  |
|`permutes` |`doParallel` |`purrr`   |`sjPlot`     |
|`ggstance` |

To install these packages simply use the `install.packages()` function and put each package name in as a character. 

**Note**: If you've already used the `here()` function in another script, you will have to open a new instance of R to ensure the relative paths works for this script (or manually change the paths).

```{r setup, include=FALSE}
# Knitr options
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)

# Load study 3 dynamic or not (large dataset)
read_study3 <- FALSE # if you want to load study 3 dynamic data make TRUE 

# Libraries
library(here)         # relative paths
library(tidyverse)    # tidy functions
library(knitr)        # knit functions
library(kableExtra)   # extra markdown functions
library(lsr)          # cohenD()
library(lme4)         # mixed-effects regressions
library(lmerTest)     # mixed-effects regressions
library(broom.mixed)  # tidy()
library(AICcmodavg)   # predictSE()
library(cowplot)      # plot_grid()
library(ggrepel)      # geom_text_repel
library(gridExtra)    # aesthetics 
library(permutes)     # permutation testing
library(doParallel)   # parallel computing 
library(purrr)        # map functions
library(sjPlot)       # clean tables
library(ggstance)     # vertical position dodge
```

## Data

The general purpose of these experiments was to determine the relative contributions emotions and rewards have on decisions to punish. Experiments 1, 2, and 4 follow a similar design and have similar data structures, while Experiment 3 was a mouse-tracking study and has extremely large data files. Currently, loading Experiment 3 is turned off by default using a simple if statement (see setup code).

```{r read_data}
# Specify relative paths
dir_analysis <- here() # should be where analysis script is stored
dir_parent <- dir_analysis %>% str_remove("/analyses")
dir_data <- str_c(dir_parent, "/data")
dir_graphs <- str_c(dir_parent, "/graphs")

# study 1 data
study1_behavior <- read_csv(str_c(dir_data, "/study1_ug/study1_ug.csv"))
study1_emotion <- read_csv(str_c(dir_data, "/study1_ug/study1_ec.csv"))

# study 2 data
study2_reward_only <- read_csv(str_c(dir_data, "/study2_rep/study2_ug_reward_only.csv"))
study2_reward_emotion<- read_csv(str_c(dir_data, "/study2_rep/study2_ug_reward_emotion.csv"))
study2_emotion <- read_csv(str_c(dir_data, "/study2_rep/study2_ec.csv"))

# study 3 static data
study3_behavior <- read_csv(str_c(dir_data, "/study3_jg/study3_jg_all_static.csv"))
study3_emotion <- read_csv(str_c(dir_data, "/study3_jg/study3_ec_static.csv")) %>% select(-X1)

# study 3 dynamic data
if (read_study3 == TRUE) {
  study3_behavior_predict <- read.csv(str_c(dir_data, "/study3_jg/study3_jg_prediction_dynamic.csv"), 
                                      header = TRUE, stringsAsFactors = FALSE)
  study3_behavior_feedback <- read.csv(str_c(dir_data, "/study3_jg/study3_jg_feedback_dynamic.csv"), 
                                       header = TRUE, stringsAsFactors = FALSE)
  study3_behavior_post <- read.csv(str_c(dir_data, "/study3_jg/study3_jg_post_dynamic.csv"), 
                                   header = TRUE, stringsAsFactors = FALSE)
  study3_behavior_decision <- read.csv(str_c(dir_data, "/study3_jg/study3_jg_post_dynamic.csv"), 
                                       header = TRUE, stringsAsFactors = FALSE)
}

# study 4 data
study4_behavior <- read_csv(str_c(dir_data, "/study4_mdd/study4_ug.csv"))
study4_emotion <- read_csv(str_c(dir_data, "/study4_mdd/study4_ec.csv"))
```

## Exclusion Criteria

`exclude` will specify whether participants correctly rated `neutral` on the circumplex. We tell participants in the instructions that "the center of the square represents a neutral, average, everyday feeling." 

We have preregistered a 100x100 pixel square around the center. If participants rate neutral within this square, they will not be excluded (`exclude = keep`) otherwise they will (`exclude = remove`).

```{r exclusion}
study1_check <- study1_emotion %>% filter(emotion == "neutral") %>% 
  mutate(exclude = if_else(between(X1, -50, 50) & between(Y1, -50, 50), "keep", "remove"), 
         study = "study1")
study2_check <- study2_emotion %>% filter(emotion == "neutral") %>%  
  mutate(exclude = if_else(between(valence, -50, 50) & between(arousal, -50, 50), "keep", "remove"), 
         study = "study2")
study3_check <- study3_emotion %>% filter(word == "Neutral") %>%  
  mutate(exclude = if_else(between(end_X, -50, 50) & between(end_Y, -50, 50), "keep", "remove"), # note columns names different
         study = "study3")
study4_check <- study4_emotion %>% filter(emotion == "neutral") %>%  
  mutate(exclude = if_else(between(X1, -50, 50) & between(Y1, -50, 50), "keep", "remove"),  # note column names different
         study = "study4")

# Report exclusions
all_checks <- study1_check %>% select(study, exclude) %>%
  bind_rows(study2_check %>% select(study, exclude)) %>%
  bind_rows(study3_check %>% select(study, exclude)) %>%
  bind_rows(study4_check %>% select(study, exclude)) %>%
  group_by(study, exclude) %>% tally()

#kable(all_checks)

## Transfer information to both emotion classificaiton and UG dataframes
# Transfer
study1_join <- study1_check %>% select(sub, exclude)
study2_join <- study2_check %>% select(sub, exclude)
study3_join <- study3_check %>% select(sub, exclude)
study4_join <- study4_check %>% select(sub, exclude)

study1_behavior <- left_join(study1_behavior, study1_join, by = "sub") %>% filter(exclude == "keep")
study2_reward_emotion <- left_join(study2_reward_emotion, study2_join, by = "sub") %>% filter(exclude == "keep")
study2_reward_only <- left_join(study2_reward_only, study2_join, by = "sub") %>% filter(exclude == "keep")
study3_behavior <- left_join(study3_behavior, study3_join, by = "sub") %>% filter(exclude == "keep")
study4_behavior <- left_join(study4_behavior, study4_join, by = "sub") %>% filter(exclude == "keep")

study1_emotion <- left_join(study1_emotion, study1_join, by = "sub") %>% filter(exclude == "keep")
study2_emotion <- left_join(study2_emotion, study2_join, by = "sub") %>% filter(exclude == "keep")
study3_emotion <- left_join(study3_emotion, study3_join, by = "sub") %>% filter(exclude == "keep")
study4_emotion <- left_join(study4_emotion, study4_join, by = "sub") %>% filter(exclude == "keep")

## study 3 dynamic (optional)
if (read_study3 == TRUE) {
  study3_behavior_predict <- left_join(study3_behavior_predict, study3_join, by = "sub") %>% filter(exclude == "keep")
  study3_behavior_feedback <- left_join(study3_behavior_feedback, study3_join, by = "sub") %>% filter(exclude == "keep")
  study3_behavior_post <- left_join(study3_behavior_post, study3_join, by = "sub") %>% filter(exclude == "keep")
  study3_behavior_decision <- left_join(study3_behavior_decision, study3_join, by = "sub") %>% filter(exclude == "keep")
}

## Standardize variables for UG
study1_behavior <- study1_behavior %>% 
  select(sub, choice, choice_RT, role, unfairness, EP_X1, EP_Y1, RP, feedback_X1, feedback_Y1, reward, EPE_X1, EPE_Y1, RPE) %>% 
  mutate(EPE_X1_scale = as.numeric(scale(EPE_X1, center = F)), 
         EPE_Y1_scale = as.numeric(scale(EPE_Y1, center = F)), 
         RPE_scale = as.numeric(scale(RPE, center = F)), 
         EP_X1_scale = as.numeric(scale(EP_X1, center = F)), 
         EP_Y1_scale = as.numeric(scale(EP_Y1, center = F)), 
         RP_scale = as.numeric(scale(RP, center = F)), 
         feedback_X1_scale = as.numeric(scale(feedback_X1, center = F)), 
         feedback_Y1_scale = as.numeric(scale(feedback_Y1, center = F)), 
         unfairness_norm = as.numeric(scale(unfairness)), 
         reward_norm = as.numeric(scale(reward)))

study2_reward_emotion <- study2_reward_emotion %>%
  mutate(reward = (100 - offer)/100, # reward in dollars
         RPE = reward - RP, 
         RPE_scale = as.numeric(scale(RPE, center=F)), 
         EPE_X1 = feedback_X1 - EP_X1, EPE_Y1 = feedback_Y1 - EP_Y1, 
         EPE_X1_scale = as.numeric(scale(EPE_X1, center = F)), EPE_Y1_scale = as.numeric(scale(EPE_Y1, center = F)))

study3_behavior <- study3_behavior

study4_behavior <- study4_behavior %>%
  select(sub, trial, unfairness, RP, EP_X1, EP_Y1, feedback_X1, feedback_Y1, choice, reward, RPE, EPE_X1, EPE_Y1, cesDepress) %>%
    mutate(EPE_X1_scale = as.numeric(scale(EPE_X1, center = F)), 
         EPE_Y1_scale = as.numeric(scale(EPE_Y1, center = F)), 
         RPE_scale = as.numeric(scale(RPE, center = F)), 
         EP_X1_scale = as.numeric(scale(EP_X1, center = F)), 
         EP_Y1_scale = as.numeric(scale(EP_Y1, center = F)), 
         RP_scale = as.numeric(scale(RP, center = F)), 
         feedback_X1_scale = as.numeric(scale(feedback_X1, center = F)), 
         feedback_Y1_scale = as.numeric(scale(feedback_Y1, center = F)), 
         unfairness_norm = as.numeric(scale(unfairness)))
```

# Experiment 1

## Fig. 1: Emotion Classification Task 

```{r fig_1}
# Reorder emotion list
emotion_list <- c("neutral", "surprised", "aroused", "peppy", "enthusiastic", "happy", "satisfied", "relaxed", "calm", "sleepy", "still", "quiet", "sluggish", "sad", "disappointed", "disgusted", "annoyed", "angry", "afraid", "nervous")

fig1a_data <- study1_emotion %>% mutate(emotion = fct_relevel(emotion, emotion_list))
fig1b_data <- study1_emotion %>% 
  mutate(emotion = fct_relevel(emotion, emotion_list)) %>%
  group_by(emotion) %>%
  dplyr::summarise(Mean_X = mean(X1), Mean_Y = mean(Y1), 
                   SD_X = sd(X1), SD_Y = sd(Y1), N = n(), 
                   SE_X = SD_X / sqrt(N), SE_Y = SD_Y / sqrt(N)) %>%
  mutate(CI.lower_X = Mean_X - qt(1 - (0.05 / 2), N - 1) * SE_X,
         CI.upper_X = Mean_X + qt(1 - (0.05 / 2), N - 1) * SE_X, 
         CI.lower_Y = Mean_Y - qt(1 - (0.05 / 2), N - 1) * SE_Y,
         CI.upper_Y = Mean_Y + qt(1 - (0.05 / 2), N - 1) * SE_Y)

fig1_plot <- ggplot(fig1b_data, aes(x = Mean_X, y = Mean_Y, color = emotion)) + 
  geom_point(size = 1) + 
  geom_errorbar(aes(ymax = CI.upper_Y, ymin = CI.lower_Y)) +
  geom_errorbarh(aes(xmax = CI.upper_X, xmin = CI.lower_X)) +
  ggrepel::geom_text_repel(aes(label = emotion), segment.colour = NA, force = 10, show.legend = FALSE, size = 4.2) +
  # Add all raw data points very transparent
  geom_point(data = fig1a_data, aes(x = X1, y = Y1, color = emotion), size = 1, alpha = .05) + 
  scale_x_continuous(name = "Valence", limits = c(-250, 250)) + 
  scale_y_continuous(name = "Arousal", limits = c(-250, 250)) + 
  scale_color_discrete(name = "Exclude") +
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14),
                     aspect.ratio = 1, legend.position = "none") # remove legend
fig1_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment1/fig1.pdf"), plot=fig1_plot, width = 6.5, height = 4, useDingbats = F)
```

## Table 1: Experiment 1: Valence prediction errors predict decisions to punish better than reward prediction errors

```{r table1}
## Table 1
table1_data <- study1_behavior

table1 <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = table1_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))

tab_model(table1, transform = NULL, title = "Experiment 1: Valence prediction errors predict decisions to punish better than reward prediction errors", 
          pred.labels = c("Intercept", "Valence PE", "Arousal PE", "Reward PE"),
          dv.labels = c("Estimates"), string.est = "Log-Odds", string.se = "SE", string.stat = "Z", 
          show.se = TRUE, show.stat = TRUE, show.ci = FALSE, 
          show.re.var = FALSE, show.aic = FALSE, show.dev = FALSE, 
          show.r2 = FALSE, show.icc = FALSE, show.obs = TRUE,
          CSS = css_theme("regression"), file = str_c(dir_graphs, "/manuscript/experiment1/table1.html"))

## likelihood ratio test comparing RPE alone to RPE + VPE
table1b <- glmer(choice ~ RPE_scale + (1 + RPE_scale|sub), 
             data = table1_data, 
             family = binomial, 
             control = glmerControl(optimizer = "bobyqa"))
table1c <- glmer(choice ~ RPE_scale + EPE_X1_scale + (1 + EPE_X1_scale + RPE_scale|sub), 
             data = table1_data, 
             family = binomial, 
             control = glmerControl(optimizer = "bobyqa"))
anova(table1c, table1b)

## likelihood ratio test comparing RPE + VPE to RPE + VPE + APE
anova(table1c, table1)

## rmcorr (intra-level correlation reported in footnote)
rmcorr::rmcorr(sub, EPE_X1_scale, RPE_scale, table1_data)

## vif (variance inflation factor reported in footnote)
round(car::vif(table1), 2)

## beta comparison test
table1_coefs <- fixef(table1)
table1_coefs_se <- sqrt(diag(vcov(table1)))
z_score <- (as.numeric(table1_coefs["EPE_X1_scale"]) - as.numeric(table1_coefs["RPE_scale"])) / (sqrt(table1_coefs_se[2]^2 + table1_coefs_se[4]^2))
pvalue <- pnorm(-abs(z_score))
```

## Subjective RPE analysis

Data to reproduce figures and tables can be found within the oscar folders of each study folder. 

## Secondary model analysis

```{r second_model}
## Table 1
table1_data <- study1_behavior

table1 <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = table1_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))

## likelihood ratio test (interactive vs additive)
table1d <- glmer(choice ~ RPE_scale*EPE_X1_scale*EPE_Y1_scale + (1 + EPE_X1_scale + RPE_scale + EPE_Y1_scale|sub), 
             data = table1_data, 
             family = binomial, 
             control = glmerControl(optimizer = "bobyqa"))
#summary(table1d)
anova(table1, table1d)
```

## Follow-up analyses (see Supplement analysis as well)

```{r follow_up}
## GAMM
tableS3_data <- study1_behavior %>% mutate(sub = factor(sub))

tableS3 <- mgcv::gamm(choice ~ s(EPE_X1_scale) + s(EPE_Y1_scale) + s(RPE_scale),
                  data = tableS3_data, 
                  family=binomial(link="logit"), 
                  random = list(sub = ~1))
#summary(tableS3$gam)

## Controlling for expectations
tableS5_data <- study1_behavior

tableS5 <- glmer(choice ~ EP_X1_scale + EP_Y1_scale + RP_scale + EPE_X1_scale + EPE_Y1_scale + RPE_scale + 
                   (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale | sub), 
                 data = tableS5_data, 
                 family=binomial(link="logit"),
                 control=glmerControl(optimizer="bobyqa",
                                      optCtrl=list(maxfun=2e5)))

## Experience only
tableS6_data <- study1_behavior 

tableS6 <- glmer(choice ~ feedback_X1_scale + feedback_Y1_scale + reward_norm + (1 + reward_norm|sub), 
            data = tableS6_data,
            family = binomial, 
            control=glmerControl(optimizer='bobyqa', 
                                optCtrl=list(maxfun=2e5))) 

## beta comparison test
tableS6_coefs <- fixef(tableS6)
tableS6_coefs_se <- sqrt(diag(vcov(tableS6)))
z_score <- (as.numeric(tableS6_coefs["reward_norm"]) - as.numeric(tableS6_coefs["feedback_X1_scale"])) / (sqrt(tableS6_coefs_se[2]^2 + tableS6_coefs_se[4]^2))
pvalue <- pnorm(-abs(z_score))

z_score <- (as.numeric(tableS6_coefs["reward_norm"]) - as.numeric(tableS6_coefs["feedback_Y1_scale"])) / (sqrt(tableS6_coefs_se[2]^2 + tableS6_coefs_se[4]^2))
pvalue <- pnorm(-abs(z_score))
```

# Experiment 2 brief analysis (see Supplement)

```{r exp2}
exp2_data <- study2_reward_emotion

exp2_table <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = exp2_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))
#summary(exp2_table)

## beta comparison test
exp2_coefs <- fixef(exp2_table)
exp2_coefs_se <- sqrt(diag(vcov(exp2_table)))
z_score <- (as.numeric(exp2_coefs["EPE_X1_scale"]) - as.numeric(exp2_coefs["RPE_scale"])) / (sqrt(exp2_coefs_se[2]^2 + exp2_coefs_se[4]^2))
pvalue <- pnorm(-abs(z_score))
```

# Figure 2

## Figure 2A

```{r fig2a}
## Table 1
table1_data <- study1_behavior

table1 <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = table1_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))

## Figure 2A
xRange1 <- with(table1_data, seq(round(min(EPE_X1_scale, na.rm=T), 1), round(max(EPE_X1_scale, na.rm=T), 1), by = .1))
xRange2 <- with(table1_data, seq(round(min(EPE_Y1_scale, na.rm=T), 1), round(max(EPE_Y1_scale, na.rm=T), 1), by = .1))
xRange3 <- with(table1_data, seq(round(min(RPE_scale, na.rm=T), 1), round(max(RPE_scale, na.rm=T), 1), by = .1))

predict1 <- with(table1_data, expand.grid(EPE_X1_scale=xRange1, EPE_Y1_scale=0, RPE_scale = 0))
predict2 <- with(table1_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=xRange2, RPE_scale = 0))
predict3 <- with(table1_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=0, RPE_scale = xRange3))

predictedInterval1 <- data.frame(predictSE(table1, newdata=predict1, type="response", print.matrix=T))
predictedInterval2 <- data.frame(predictSE(table1, newdata=predict2, type="response", print.matrix=T))
predictedInterval3 <- data.frame(predictSE(table1, newdata=predict3, type="response", print.matrix=T))

plot_data1 <- bind_cols(predict1, predictedInterval1)
plot_data2 <- bind_cols(predict2, predictedInterval2)
plot_data3 <- bind_cols(predict3, predictedInterval3)

fig2a_plot <- ggplot() + 
  # Valence PE
  geom_line(data = plot_data1, aes(x = EPE_X1_scale, y = fit, color = "Valence PE"), size = 1.5) + 
  geom_ribbon(data = plot_data1, aes(x = EPE_X1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Valence PE"), alpha = .2) + 
  # Arousal PE
  geom_line(data = plot_data2, aes(x = EPE_Y1_scale, y = fit, color = "Arousal PE"), size = 1.5) + 
  geom_ribbon(data = plot_data2, aes(x = EPE_Y1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Arousal PE"), alpha = .2) + 
  # Reward PE
  geom_line(data = plot_data3, aes(x = RPE_scale, y = fit, color = "Reward PE"), size = 1.5) + 
  geom_ribbon(data = plot_data3, aes(x = RPE_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Reward PE"), alpha = .2) + 
  scale_color_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + # arousal, reward, valence order (Paul Tol's colors)
  scale_fill_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + 
  scale_y_continuous(labels = scales::percent, limits = c(0, 1), name = "p(Reject)") +
  scale_x_continuous(limits = c(-5.0, 5.0), name = "Prediction Errors") +
  annotate("text", label = "***", x = -2.1, y = .85, size = 14, color = "#4477AA", angle = -58) + # valence
  annotate("text", label = "***", x = 2.5, y = .29, size = 14, color = "#EE6677", angle = 34) + # arousal
  annotate("text", label = "***", x = -2.15, y = .25, size = 14, color = "#228833", angle = -58) + # reward
  geom_vline(xintercept = 0, lty = 3) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20))
fig2a_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment1/fig2a.pdf"), plot=fig2a_plot, width = 6, height = 4, useDingbats = F)
```

## Fig. 2B - Reverse vs Comp

```{r fig2b}
## Fig. 2b
fig2b_data <- study3_behavior %>% 
         filter(optionType == 6, # COMP / REV
         rp >= 0) %>% # remove trials with reward prediction error (if any)
  mutate(EPE_X1_scale = as.numeric(scale(EPE_X, center = FALSE)), 
         EPE_Y1_scale = as.numeric(scale(EPE_Y, center = FALSE)),
         RPE_scale = as.numeric(scale(RPE, center = FALSE)), 
         choice = ifelse(choice == "REVERSE", 1, 0))

fig2b_model <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + RPE_scale|sub), 
            data = fig2b_data,
            family = binomial, 
            control=glmerControl(optimizer='bobyqa', 
                                optCtrl=list(maxfun=2e5)))
#summary(fig2b_model)

## Figure 2B
xRange1 <- with(fig2b_data, seq(round(min(EPE_X1_scale, na.rm=T), 1), round(max(EPE_X1_scale, na.rm=T), 1), by = .1))
xRange2 <- with(fig2b_data, seq(round(min(EPE_Y1_scale, na.rm=T), 1), round(max(EPE_Y1_scale, na.rm=T), 1), by = .1))
xRange3 <- with(fig2b_data, seq(round(min(RPE_scale, na.rm=T), 1), round(max(RPE_scale, na.rm=T), 1), by = .1))

predict1 <- with(fig2b_data, expand.grid(EPE_X1_scale=xRange1, EPE_Y1_scale=0, RPE_scale = 0))
predict2 <- with(fig2b_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=xRange2, RPE_scale = 0))
predict3 <- with(fig2b_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=0, RPE_scale = xRange3))

predictedInterval1 <- data.frame(predictSE(fig2b_model, newdata=predict1, type="response", print.matrix=T))
predictedInterval2 <- data.frame(predictSE(fig2b_model, newdata=predict2, type="response", print.matrix=T))
predictedInterval3 <- data.frame(predictSE(fig2b_model, newdata=predict3, type="response", print.matrix=T))

plot_data1 <- bind_cols(predict1, predictedInterval1)
plot_data2 <- bind_cols(predict2, predictedInterval2)
plot_data3 <- bind_cols(predict3, predictedInterval3)

fig2b_plot <- ggplot() + 
  # Valence PE
  geom_line(data = plot_data1, aes(x = EPE_X1_scale, y = fit, color = "Valence PE"), size = 1.5) + 
  geom_ribbon(data = plot_data1, aes(x = EPE_X1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Valence PE"), alpha = .2) + 
  # Arousal PE
  geom_line(data = plot_data2, aes(x = EPE_Y1_scale, y = fit, color = "Arousal PE"), size = 1.5) + 
  geom_ribbon(data = plot_data2, aes(x = EPE_Y1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Arousal PE"), alpha = .2) + 
  # Reward PE
  geom_line(data = plot_data3, aes(x = RPE_scale, y = fit, color = "Reward PE"), size = 1.5) + 
  geom_ribbon(data = plot_data3, aes(x = RPE_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Reward PE"), alpha = .2) + 
  scale_color_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + # arousal, reward, valence order (Paul Tol's colors)
  scale_fill_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reverse)") +
  coord_cartesian(xlim = c(-5.0, 5.), ylim = c(0, 1)) + 
  scale_x_continuous(name = "Prediction Errors") +
  annotate("text", label = "***", x = -1.5, y = .85, size = 14, color = "#4477AA", angle = -58) + # valence
  annotate("text", label = "n.s.", x = 2.5, y = .29, size = 6, color = "#EE6677", angle = 34) + # arousal
  annotate("text", label = "*", x = -2.15, y = .25, size = 14, color = "#228833", angle = -58) + # reward
  geom_vline(xintercept = 0, lty = 3) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20))
fig2b_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment3/fig2b.pdf"), plot=fig2b_plot, width = 6, height = 4, useDingbats = F)

## beta comparison
fig2b_coefs <- fixef(fig2b_model)
fig2b_coefs_se <- sqrt(diag(vcov(fig2b_model)))
z_score <- (as.numeric(fig2b_coefs["EPE_X1_scale"]) - as.numeric(fig2b_coefs["RPE_scale"])) / (sqrt(fig2b_coefs_se[2]^2 + fig2b_coefs_se[4]^2))
pvalue <- pnorm(-abs(z_score))
```

## Fig. 2C - Accept vs Punish

```{r fig2c}
## Fig. 2C
fig2c_data <- study3_behavior %>% 
         filter(optionType == 1, # PUNISH / ACCEPT
         rp >= 0) %>% # remove trials with reward prediction error (if any)
  mutate(EPE_X1_scale = as.numeric(scale(EPE_X, center = FALSE)), 
         EPE_Y1_scale = as.numeric(scale(EPE_Y, center = FALSE)),
         RPE_scale = as.numeric(scale(RPE, center = FALSE)), 
         choice = ifelse(choice == "PUNISH", 1, 0))

fig2c_model <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + RPE_scale|sub), 
            data = fig2c_data,
            family = binomial, 
            control=glmerControl(optimizer='bobyqa', 
                                optCtrl=list(maxfun=2e5)))

## Figure 2C
xRange1 <- with(fig2c_data, seq(round(min(EPE_X1_scale, na.rm=T), 1), round(max(EPE_X1_scale, na.rm=T), 1), by = .1))
xRange2 <- with(fig2c_data, seq(round(min(EPE_Y1_scale, na.rm=T), 1), round(max(EPE_Y1_scale, na.rm=T), 1), by = .1))
xRange3 <- with(fig2c_data, seq(round(min(RPE_scale, na.rm=T), 1), round(max(RPE_scale, na.rm=T), 1), by = .1))

predict1 <- with(fig2c_data, expand.grid(EPE_X1_scale=xRange1, EPE_Y1_scale=0, RPE_scale = 0))
predict2 <- with(fig2c_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=xRange2, RPE_scale = 0))
predict3 <- with(fig2c_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=0, RPE_scale = xRange3))

predictedInterval1 <- data.frame(predictSE(fig2c_model, newdata=predict1, type="response", print.matrix=T))
predictedInterval2 <- data.frame(predictSE(fig2c_model, newdata=predict2, type="response", print.matrix=T))
predictedInterval3 <- data.frame(predictSE(fig2c_model, newdata=predict3, type="response", print.matrix=T))

plot_data1 <- bind_cols(predict1, predictedInterval1)
plot_data2 <- bind_cols(predict2, predictedInterval2)
plot_data3 <- bind_cols(predict3, predictedInterval3)

fig2c_plot <- ggplot() + 
  # Valence PE
  geom_line(data = plot_data1, aes(x = EPE_X1_scale, y = fit, color = "Valence PE"), size = 1.5) + 
  geom_ribbon(data = plot_data1, aes(x = EPE_X1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Valence PE"), alpha = .2) + 
  # Arousal PE
  geom_line(data = plot_data2, aes(x = EPE_Y1_scale, y = fit, color = "Arousal PE"), size = 1.5) + 
  geom_ribbon(data = plot_data2, aes(x = EPE_Y1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Arousal PE"), alpha = .2) + 
  # Reward PE
  geom_line(data = plot_data3, aes(x = RPE_scale, y = fit, color = "Reward PE"), size = 1.5) + 
  geom_ribbon(data = plot_data3, aes(x = RPE_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Reward PE"), alpha = .2) + 
  scale_color_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + # arousal, reward, valence order (Paul Tol's colors)
  scale_fill_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reject)") +
  coord_cartesian(xlim = c(-5.0, 5.), ylim = c(0, 1)) + 
  scale_x_continuous(name = "Prediction Errors") +
  annotate("text", label = "***", x = -1.5, y = .85, size = 14, color = "#4477AA", angle = -58) + # valence
  annotate("text", label = "n.s.", x = 2.5, y = .29, size = 6, color = "#EE6677", angle = 34) + # arousal
  annotate("text", label = "***", x = -2.15, y = .25, size = 14, color = "#228833", angle = -58) + # reward
  geom_vline(xintercept = 0, lty = 3) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20))
fig2c_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment3/fig2c.pdf"), plot=fig2c_plot, width = 6, height = 4, useDingbats = F)

## beta comparison
fig2c_coefs <- fixef(fig2c_model)
fig2c_coefs_se <- sqrt(diag(vcov(fig2c_model)))
z_score <- (as.numeric(fig2c_coefs["EPE_X1_scale"]) - as.numeric(fig2c_coefs["RPE_scale"])) / (sqrt(fig2c_coefs_se[2]^2 + fig2c_coefs_se[4]^2))
pvalue <- pnorm(-abs(z_score))
```

## Experiment 3 Subjective RPE Model (see `epe_model.Rmd` in oscar folder)

# Figure 3 (see Supplement for statistics and visualization)

# Table 2 

```{r table2}
table2_data <- study4_behavior %>%
  mutate(cesDepress_binary = case_when(cesDepress == "Healthy_Controls" ~ 0, 
                                       cesDepress == "Clinically_Depressed" ~ 1))

table2 <- glmer(choice ~ unfairness_norm*cesDepress_binary + (1 + unfairness_norm|sub), 
                data = table2_data,
                family = binomial, 
                control=glmerControl(optimizer='bobyqa', 
                                     optCtrl=list(maxfun=2e5)))

tab_model(table2, transform = NULL, title = "Experiment 4: Individuals at risk of depression are less sensitive to unfairness", 
          pred.labels = c("Intercept", "Unfairness", "Depression", "Unfairness:Depression"),
          dv.labels = c("Estimates"), string.est = "Log-Odds", string.se = "SE", string.stat = "Z", 
          show.se = TRUE, show.stat = TRUE, show.ci = FALSE, 
          show.re.var = FALSE, show.aic = FALSE, show.dev = FALSE, 
          show.r2 = FALSE, show.icc = FALSE, show.obs = TRUE,
          CSS = css_theme("regression"), file = str_c(dir_graphs, "/manuscript/experiment4/table2.html"))
```

# Experiment 4: Intext analyses

```{r exp4 intext}
## Not at risk
e4_healthy <- study4_behavior %>% filter(cesDepress == "Healthy_Controls")

e4_healthy_model <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
                data = e4_healthy,
                family = binomial, 
                control=glmerControl(optimizer='bobyqa', 
                                     optCtrl=list(maxfun=2e5)))
summary(e4_healthy_model)

## beta comparison
e4_healthy_coefs <- fixef(e4_healthy_model)
e4_healthy_se <- sqrt(diag(vcov(e4_healthy_model)))
z_score <- (as.numeric(e4_healthy_coefs["EPE_X1_scale"]) - as.numeric(e4_healthy_coefs["RPE_scale"])) / (sqrt(e4_healthy_se[2]^2 + e4_healthy_se[4]^2))
pvalue <- pnorm(-abs(z_score))

## At risk
e4_depress <- study4_behavior %>% filter(cesDepress == "Clinically_Depressed")

e4_depress_model <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
                data = e4_depress,
                family = binomial, 
                control=glmerControl(optimizer='bobyqa', 
                                     optCtrl=list(maxfun=2e5)))
summary(e4_depress_model)

## beta comparison
e4_depress_coefs <- fixef(e4_depress_model)
e4_depress_se <- sqrt(diag(vcov(e4_depress_model)))
z_score <- (as.numeric(e4_depress_coefs["RPE_scale"]) - as.numeric(e4_depress_coefs["EPE_X1_scale"])) / (sqrt(e4_depress_se[4]^2 + e4_depress_se[2]^2))
pvalue <- pnorm(-abs(z_score))
```

# Table 3

```{r table3}
table3_data <- study4_behavior %>%
  mutate(cesDepress_binary = case_when(cesDepress == "Healthy_Controls" ~ 0, 
                                       cesDepress == "Clinically_Depressed" ~ 1))

table3 <- glmer(choice ~ EPE_X1_scale*cesDepress_binary + EPE_Y1_scale*cesDepress_binary + RPE_scale*cesDepress_binary + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
                data = table3_data,
                family = binomial, 
                control=glmerControl(optimizer='bobyqa', 
                                     optCtrl=list(maxfun=2e5)))

tab_model(table3, transform = NULL, title = "Experiment 4: Individuals at risk of depression have selective impairment in emotion (but not reward) prediction errors", 
          pred.labels = c("Intercept", "Valence PE", "Depression", "Arousal PE", "Reward PE",
                          "Valence PE:Depression", "Arousal PE:Depression", "Reward PE:Depression"),
          dv.labels = c("Estimates"), string.est = "Log-Odds", string.se = "SE", string.stat = "Z", 
          show.se = TRUE, show.stat = TRUE, show.ci = FALSE, 
          show.re.var = FALSE, show.aic = FALSE, show.dev = FALSE, 
          show.r2 = FALSE, show.icc = FALSE, show.obs = TRUE,
          CSS = css_theme("regression"), file = str_c(dir_graphs, "/manuscript/experiment4/table3.html"))

```

# Figure 4

## Figure 4a

```{r fig4a}
## Healthy
tableS11_data <- study4_behavior %>% 
  filter(cesDepress == "Healthy_Controls")

tableS11 <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = tableS11_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))

xRange1 <- with(tableS11_data, seq(round(min(EPE_X1_scale, na.rm=T), 1), round(max(EPE_X1_scale, na.rm=T), 1), by = .1))
xRange2 <- with(tableS11_data, seq(round(min(EPE_Y1_scale, na.rm=T), 1), round(max(EPE_Y1_scale, na.rm=T), 1), by = .1))
xRange3 <- with(tableS11_data, seq(round(min(RPE_scale, na.rm=T), 1), round(max(RPE_scale, na.rm=T), 1), by = .1))

predict1 <- with(tableS11_data, expand.grid(EPE_X1_scale=xRange1, EPE_Y1_scale=0, RPE_scale = 0))
predict2 <- with(tableS11_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=xRange2, RPE_scale = 0))
predict3 <- with(tableS11_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=0, RPE_scale = xRange3))

predictedInterval1 <- data.frame(AICcmodavg::predictSE(tableS11, newdata=predict1, type="response", print.matrix=T))
predictedInterval2 <- data.frame(AICcmodavg::predictSE(tableS11, newdata=predict2, type="response", print.matrix=T))
predictedInterval3 <- data.frame(AICcmodavg::predictSE(tableS11, newdata=predict3, type="response", print.matrix=T))

plot_data1 <- bind_cols(predict1, predictedInterval1)
plot_data2 <- bind_cols(predict2, predictedInterval2)
plot_data3 <- bind_cols(predict3, predictedInterval3)

fig4a_plot1 <- ggplot() + 
  # Valence PE
  geom_line(data = plot_data1, aes(x = EPE_X1_scale, y = fit, color = "Valence PE"), size = 1.5) + 
  geom_ribbon(data = plot_data1, aes(x = EPE_X1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Valence PE"), alpha = .2) + 
  # Arousal PE
  geom_line(data = plot_data2, aes(x = EPE_Y1_scale, y = fit, color = "Arousal PE"), size = 1.5) + 
  geom_ribbon(data = plot_data2, aes(x = EPE_Y1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Arousal PE"), alpha = .2) + 
  # Reward PE
  geom_line(data = plot_data3, aes(x = RPE_scale, y = fit, color = "Reward PE"), size = 1.5) + 
  geom_ribbon(data = plot_data3, aes(x = RPE_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Reward PE"), alpha = .2) + 
  scale_color_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + # arousal, reward, valence order (Paul Tol's colors)
  scale_fill_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reject)") +
  coord_cartesian(xlim = c(-5.0, 5.), ylim = c(0, 1)) + 
  scale_x_continuous(name = "Prediction Errors") +
  annotate("text", label = "***", x = -1.5, y = .85, size = 14, color = "#4477AA", angle = -58) + # valence
  annotate("text", label = "**", x = 2.5, y = .29, size = 14, color = "#EE6677", angle = 34) + # arousal
  annotate("text", label = "***", x = -2.15, y = .25, size = 14, color = "#228833", angle = -58) + # reward
  geom_vline(xintercept = 0, lty = 3) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20))
fig4a_plot1
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4a_healthy.pdf"), plot=fig4a_plot1, width = 5.5, height = 4, useDingbats = F)

## Depress
tableS12_data <- study4_behavior %>% 
  filter(cesDepress == "Clinically_Depressed")

tableS12 <- glmer(choice ~ EPE_X1_scale + EPE_Y1_scale + RPE_scale + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = tableS12_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))

xRange1 <- with(tableS12_data, seq(round(min(EPE_X1_scale, na.rm=T), 1), round(max(EPE_X1_scale, na.rm=T), 1), by = .1))
xRange2 <- with(tableS12_data, seq(round(min(EPE_Y1_scale, na.rm=T), 1), round(max(EPE_Y1_scale, na.rm=T), 1), by = .1))
xRange3 <- with(tableS12_data, seq(round(min(RPE_scale, na.rm=T), 1), round(max(RPE_scale, na.rm=T), 1), by = .1))

predict1 <- with(tableS12_data, expand.grid(EPE_X1_scale=xRange1, EPE_Y1_scale=0, RPE_scale = 0))
predict2 <- with(tableS12_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=xRange2, RPE_scale = 0))
predict3 <- with(tableS12_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=0, RPE_scale = xRange3))

predictedInterval1 <- data.frame(AICcmodavg::predictSE(tableS12, newdata=predict1, type="response", print.matrix=T))
predictedInterval2 <- data.frame(AICcmodavg::predictSE(tableS12, newdata=predict2, type="response", print.matrix=T))
predictedInterval3 <- data.frame(AICcmodavg::predictSE(tableS12, newdata=predict3, type="response", print.matrix=T))

plot_data1 <- bind_cols(predict1, predictedInterval1)
plot_data2 <- bind_cols(predict2, predictedInterval2)
plot_data3 <- bind_cols(predict3, predictedInterval3)

fig4a_plot2 <- ggplot() + 
  # Valence PE
  geom_line(data = plot_data1, aes(x = EPE_X1_scale, y = fit, color = "Valence PE"), size = 1.5) + 
  geom_ribbon(data = plot_data1, aes(x = EPE_X1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Valence PE"), alpha = .2) + 
  # Arousal PE
  geom_line(data = plot_data2, aes(x = EPE_Y1_scale, y = fit, color = "Arousal PE"), size = 1.5) + 
  geom_ribbon(data = plot_data2, aes(x = EPE_Y1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Arousal PE"), alpha = .2) + 
  # Reward PE
  geom_line(data = plot_data3, aes(x = RPE_scale, y = fit, color = "Reward PE"), size = 1.5) + 
  geom_ribbon(data = plot_data3, aes(x = RPE_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = "Reward PE"), alpha = .2) + 
  scale_color_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + # arousal, reward, valence order (Paul Tol's colors)
  scale_fill_manual(name = "Color", values = c("#EE6677", "#228833", "#4477AA")) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reject)") +
  coord_cartesian(xlim = c(-5.0, 5.), ylim = c(0, 1)) + 
  scale_x_continuous(name = "Prediction Errors") +
  annotate("text", label = "***", x = -2.15, y = .25, size = 14, color = "#4477AA", angle = -58) + # valence
  annotate("text", label = "n.s.", x = 2.5, y = .29, size = 6, color = "#EE6677", angle = 34) + # arousal
  annotate("text", label = "***", x = -1.5, y = .85, size = 14, color = "#228833", angle = -58) + # reward
  geom_vline(xintercept = 0, lty = 3) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20))
fig4a_plot2
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4a_depress.pdf"), plot=fig4a_plot2, width = 5.5, height = 4, useDingbats = F)
```

## Figure 4b

```{r fig4b}
fig4b_data <- study4_behavior %>% 
  select(sub, choice, cesDepress, EPE_X1_scale, EPE_Y1_scale, RPE_scale) %>% 
  mutate(depression_binary = ifelse(cesDepress == "Healthy_Controls", 0, 1))
  
fig4b_model <- glmer(choice ~ EPE_X1_scale*depression_binary + EPE_Y1_scale*depression_binary + RPE_scale*depression_binary + (1 + EPE_X1_scale + EPE_Y1_scale + RPE_scale|sub), 
            data = fig4b_data,
            family = binomial, 
            control = glmerControl(optimizer = "bobyqa"))

# Graph
xRange1 <- with(fig4b_data, seq(round(min(EPE_X1_scale, na.rm=T), 1), round(max(EPE_X1_scale, na.rm=T), 1), by = .1))
xRange2 <- with(fig4b_data, seq(round(min(EPE_Y1_scale, na.rm=T), 1), round(max(EPE_Y1_scale, na.rm=T), 1), by = .1))
xRange3 <- with(fig4b_data, seq(round(min(RPE_scale, na.rm=T), 1), round(max(RPE_scale, na.rm=T), 1), by = .1))

predict1 <- with(fig4b_data, expand.grid(EPE_X1_scale=xRange1, EPE_Y1_scale=0, RPE_scale = 0, depression_binary = c(0, 1)))
predict2 <- with(fig4b_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=xRange2, RPE_scale = 0, depression_binary = c(0, 1)))
predict3 <- with(fig4b_data, expand.grid(EPE_X1_scale=0, EPE_Y1_scale=0, RPE_scale = xRange3, depression_binary = c(0, 1)))

predictedInterval1 <- data.frame(predictSE(fig4b_model, newdata=predict1, type="response", print.matrix=T))
predictedInterval2 <- data.frame(predictSE(fig4b_model, newdata=predict2, type="response", print.matrix=T))
predictedInterval3 <- data.frame(predictSE(fig4b_model, newdata=predict3, type="response", print.matrix=T))

plot_data1 <- bind_cols(predict1, predictedInterval1) %>% 
  mutate(depression_binary = case_when(depression_binary == 0 ~ "Healthy Control", 
                                        depression_binary == 1 ~ "Depression"))
plot_data2 <- bind_cols(predict2, predictedInterval2) %>% 
   mutate(depression_binary = case_when(depression_binary == 0 ~ "Healthy Control", 
                                        depression_binary == 1 ~ "Depression"))
plot_data3 <- bind_cols(predict3, predictedInterval3) %>% 
  mutate(depression_binary = case_when(depression_binary == 0 ~ "Healthy Control", 
                                        depression_binary == 1 ~ "Depression"))

# Figure 4b
fig4b_plot1 <- ggplot() + 
  # Valence PE
  geom_line(data = plot_data1, aes(x = EPE_X1_scale, y = fit, color = depression_binary), size = 1.5) + 
  geom_ribbon(data = plot_data1, aes(x = EPE_X1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = depression_binary), alpha = .2) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reject)") +
  xlab("Valence PE") + 
  scale_color_manual(name = "Clinical Group", values = c("#BB5566", "#004488")) + # Paul Tol
  scale_fill_manual(name = "Clinical Group", values = c("#BB5566", "#004488")) + # Paul Tol
  coord_cartesian(ylim = c(0, 1)) + 
  geom_vline(xintercept = 0, lty = 3) + 
  #annotate("segment", x = -3, xend = 3, y = 1, yend = 1) + 
  #annotate("text", label = "**", x = 0, y = 1.02) + 
  theme_bw() + theme(text = element_text(size = 20), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

fig4b_plot2 <- ggplot() + 
  # Arousal PE
  geom_line(data = plot_data2, aes(x = EPE_Y1_scale, y = fit, color = depression_binary), size = 1.5) + 
  geom_ribbon(data = plot_data2, aes(x = EPE_Y1_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = depression_binary), alpha = .2) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reject)") +
  coord_cartesian(ylim = c(0, 1)) + 
  xlab("Arousal PE") + 
  scale_color_manual(name = "Clinical Group", values = c("#BB5566", "#004488")) + # Paul Tol
  scale_fill_manual(name = "Clinical Group", values = c("#BB5566", "#004488")) + # Paul Tol
  geom_vline(xintercept = 0, lty = 3) + 
  #annotate("segment", x = -3, xend = 3, y = 1, yend = 1) + 
  #annotate("text", label = "*", x = 0, y = 1.02) + 
  theme_bw() + theme(text = element_text(size = 20), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

fig4b_plot3 <- ggplot() + 
  geom_line(data = plot_data3, aes(x = RPE_scale, y = fit, color = depression_binary), size = 1.5) + 
  geom_ribbon(data = plot_data3, aes(x = RPE_scale, ymax = fit + se.fit, ymin = fit - se.fit, fill = depression_binary), alpha = .2) + 
  scale_y_continuous(labels = scales::percent, name = "p(Reject)") +
  coord_cartesian(ylim = c(0, 1)) + 
  scale_color_manual(name = "Clinical Group", values = c("#BB5566", "#004488")) + # Paul Tol
  scale_fill_manual(name = "Clinical Group", values = c("#BB5566", "#004488")) + # Paul Tol
  xlab("Reward PE") + 
  geom_vline(xintercept = 0, lty = 3) + 
  #annotate("segment", x = -3, xend = 3, y = 1, yend = 1) + 
  #annotate("text", label = "n.s.", x = 0, y = 1.02) + 
  theme_bw() + theme(text = element_text(size = 20), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

fig4b_plot <- cowplot::plot_grid(fig4b_plot1, fig4b_plot2, fig4b_plot3, nrow = 1)
fig4b_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4b.pdf"), plot=fig4b_plot, width = 16, height = 6, useDingbats = F)

# Save separately
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4b_1.pdf"), plot=fig4b_plot1, width = 5.5, height = 4, useDingbats = F)
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4b_2.pdf"), plot=fig4b_plot2, width = 5.5, height = 4, useDingbats = F)
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4b_3.pdf"), plot=fig4b_plot3, width = 5.5, height = 4, useDingbats = F)
```

## Figure 4c

```{r fig4c}
## Circumplex fit radius
# Function requires only 1 subject's emotion classification data
circumplex_fit <- function(df) {
  
  # Define center for subject using neutral
  centerX <- df$X1[df$emotion == "neutral"]
  centerY <- df$Y1[df$emotion == "neutral"]
  
  # calculate
  df$distance <- sqrt((df$X1 - centerX)^2 + (df$Y1 - centerY)^2)
  df$angle_rad <- atan2(df$Y1, df$X1) # R returns radians
  df$angle_deg <- df$angle_rad * 180/pi # Angle degree = rad * 180 / pi
  df$centerX <- centerX
  df$centerY <- centerY
  
  # Find mean "radius" which we'll use for the circumplex
  Mean_Dist <- df %>% 
    filter(emotion != "neutral") %>% # don't want our center influencing the average
    summarise(Mean_Dist = mean(distance)) %>%
    pull(Mean_Dist)

  return(Mean_Dist)
}

# Fit circumplex and pull out radius per subject
study4_emotion_fits <- study4_emotion %>% 
  nest(data = -sub) %>% 
  group_by(sub) %>% 
  mutate(radius = map(data, circumplex_fit)) %>% # returns radius
  unnest(cols = c(data, radius))

fig4c_data <- study4_emotion_fits %>% select(sub, cesDepress, radius) %>% unique()

# Test for normal distribution
#shapiro.test(fig4c_data$radius[fig4c_data$cesDepress == "Healthy_Controls"])
#shapiro.test(fig4c_data$radius[fig4c_data$cesDepress == "Clinically_Depressed"])

# Histogram 
fig4c_plot <- ggplot(fig4c_data, aes(x = radius)) + 
  # Healthy Controls
  stat_function(# creates a normal distribution with mean of W parameter and sd!
    fun = function(x, mean, sd, n, bw){ 
      dnorm(x = x, mean = mean, sd = sd) * n * bw
    }, 
    args = c(mean = mean(fig4c_data$radius[fig4c_data$cesDepress == "Healthy_Controls"]), 
             sd = sd(fig4c_data$radius[fig4c_data$cesDepress == "Healthy_Controls"]), 
             n = length(fig4c_data$radius[fig4c_data$cesDepress == "Healthy_Controls"]), 
             bw = 10), color = "#004488", size = 1) +
  geom_vline(xintercept = mean(fig4c_data$radius[fig4c_data$cesDepress == "Healthy_Controls"]), colour = "#004488", linetype = "dashed") +
  # Clinically Depressed
  stat_function(
    fun = function(x, mean, sd, n, bw){ 
      dnorm(x = x, mean = mean, sd = sd) * n * bw
    }, 
    args = c(mean = mean(fig4c_data$radius[fig4c_data$cesDepress == "Clinically_Depressed"]), 
             sd = sd(fig4c_data$radius[fig4c_data$cesDepress == "Clinically_Depressed"]), 
             n = length(fig4c_data$radius[fig4c_data$cesDepress == "Clinically_Depressed"]), 
             bw = 10), color = "#BB5566", size = 1) +
  geom_vline(xintercept = mean(fig4c_data$radius[fig4c_data$cesDepress == "Clinically_Depressed"]), colour = "#BB5566", linetype = "dashed") +
  # Theme
  annotate("text", x = 100, y = 20, color = "#004488", 
           label = "Healthy Controls") +
  annotate("text", x = 100, y = 19, color = "#BB5566", 
           label = "Clinically Depressed") +
  scale_x_continuous(breaks = c(50, 100, 150, 200, 250, 300), name = "Radius") +
  scale_y_continuous(name = "Count") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20), legend.position = "none") # remove legend
fig4c_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4c.pdf"), plot=fig4c_plot, width = 4, height = 4, useDingbats = F)

# Statistical test
clinical_radius <- fig4c_data %>% filter(cesDepress == "Clinically_Depressed") %>% pull(radius)
healthy_radius <- fig4c_data %>% filter(cesDepress == "Healthy_Controls") %>% pull(radius)

t.test(healthy_radius, clinical_radius)
effsize::cohen.d(healthy_radius, clinical_radius, hedges.correction = TRUE)
```

## Figure 4d

```{r figure 4d}
# Reorder emotion list
emotion_list <- c("neutral", "surprised", "aroused", "peppy", "enthusiastic", "happy", "satisfied", "relaxed", "calm", "sleepy", "still", "quiet", "sluggish", "sad", "disappointed", "disgusted", "annoyed", "angry", "afraid", "nervous")

# Figure 4d
fig4d_data <- study4_emotion %>%
  mutate(emotion = fct_relevel(emotion, emotion_list)) %>%
  mutate(cesDepress = fct_relevel(cesDepress, c("Healthy_Controls", "Clinically_Depressed"))) %>%
  group_by(emotion, cesDepress) %>%
  dplyr::summarise(Mean_X = mean(X1), Mean_Y = mean(Y1), 
                   SD_X = sd(X1), SD_Y = sd(Y1), N = n(), 
                   SE_X = SD_X / sqrt(N), SE_Y = SD_Y / sqrt(N)) %>%
  mutate(CI.lower_X = Mean_X - qt(1 - (0.05 / 2), N - 1) * SE_X,
         CI.upper_X = Mean_X + qt(1 - (0.05 / 2), N - 1) * SE_X, 
         CI.lower_Y = Mean_Y - qt(1 - (0.05 / 2), N - 1) * SE_Y,
         CI.upper_Y = Mean_Y + qt(1 - (0.05 / 2), N - 1) * SE_Y)

# Radius circumplex fits to group level data
# Healthy
fig4d_data_healthy <- fig4d_data %>% ungroup() %>% filter(cesDepress == "Healthy_Controls")

centerX <- fig4d_data_healthy$Mean_X[fig4d_data_healthy$emotion == "neutral"]
centerY <- fig4d_data_healthy$Mean_Y[fig4d_data_healthy$emotion == "neutral"]

fig4d_data_healthy$distance <- sqrt((fig4d_data_healthy$Mean_X - centerX)^2 + (fig4d_data_healthy$Mean_Y - centerY)^2)
fig4d_data_healthy$angle_rad <- atan2(fig4d_data_healthy$Mean_Y, fig4d_data_healthy$Mean_X) # R returns radians
fig4d_data_healthy$angle_deg <- fig4d_data_healthy$angle_rad * 180/pi

fig4d_data_healthy_circle <- fig4d_data_healthy %>% 
  filter(emotion != "neutral") %>%
  summarise(radius = mean(distance)) # don't want our center influencing the average
fig4d_data_healthy_circle$centerX <- centerX
fig4d_data_healthy_circle$centerY <- centerY
fig4d_data_healthy_circle$cesDepress <- "Healthy_Controls"

# Depress
fig4d_data_depress <- fig4d_data %>% ungroup() %>% filter(cesDepress == "Clinically_Depressed")

centerX <- fig4d_data_depress$Mean_X[fig4d_data_depress$emotion == "neutral"]
centerY <- fig4d_data_depress$Mean_Y[fig4d_data_depress$emotion == "neutral"]

fig4d_data_depress$distance <- sqrt((fig4d_data_depress$Mean_X - centerX)^2 + (fig4d_data_depress$Mean_Y - centerY)^2)
fig4d_data_depress$angle_rad <- atan2(fig4d_data_depress$Mean_Y, fig4d_data_depress$Mean_X) # R returns radians
fig4d_data_depress$angle_deg <- fig4d_data_depress$angle_rad * 180/pi

fig4d_data_depress_circle <- fig4d_data_depress %>% 
  filter(emotion != "neutral") %>%
  summarise(radius = mean(distance)) # don't want our center influencing the average
fig4d_data_depress_circle$centerX <- centerX
fig4d_data_depress_circle$centerY <- centerY
fig4d_data_depress_circle$cesDepress <- "Clinically_Depressed"

# Radius data
fig4d_data_circle <- bind_rows(fig4d_data_healthy_circle, fig4d_data_depress_circle) %>%
  mutate(cesDepress = fct_relevel(cesDepress, c("Healthy_Controls", "Clinically_Depressed")))

# Figure 4d plot
fig4d_plot <- ggplot(fig4d_data, aes(x = Mean_X, y = Mean_Y, color = emotion)) + 
  geom_point(size = 1) + 
  geom_errorbar(aes(ymax = CI.upper_Y, ymin = CI.lower_Y)) +
  geom_errorbarh(aes(xmax = CI.upper_X, xmin = CI.lower_X)) +
  scale_x_continuous(name = "Valence", limits = c(-250, 250)) + 
  scale_y_continuous(name = "Arousal", limits = c(-250, 250)) + 
  scale_color_discrete(name = "Exclude") +
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0) +
  ggforce::geom_circle(data = fig4d_data_circle, aes(x0 = centerX, y0 = centerY, r = radius, x = NULL, y = NULL, color = NULL)) +
  ggrepel::geom_text_repel(aes(label = emotion), segment.colour = NA, force = 10, show.legend = FALSE, size = 5) +
  facet_wrap(~cesDepress) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
                     text = element_text(size = 14), title = element_text(size = 20),
                     aspect.ratio = 1, legend.position = "none") # remove legend
fig4d_plot
ggsave(filename = paste0(dir_graphs, "/manuscript/experiment4/fig4d.pdf"), plot=fig4d_plot, width = 8, height = 6, useDingbats = F)
```
